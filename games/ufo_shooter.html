<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UFOã‚·ãƒ¥ãƒ¼ã‚¿ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: 'Inter', sans-serif; /* ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š */
            overscroll-behavior: none; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€£é–ã‚’é˜²æ­¢ */
        }
        .monitor-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            width: 400px; /* ãƒ¢ãƒ‹ã‚¿ãƒ¼ã®å¹… */
            height: 400px; /* ãƒ¢ãƒ‹ã‚¿ãƒ¼ã®é«˜ã• */
            border: 2px solid #666;
            background-color: #111; /* èƒŒæ™¯è‰² */
            border-radius: 8px; /* è§’ä¸¸ */
        }
        .monitor-cell {
            border: 1px solid #444; /* ã‚»ãƒ«ã®å¢ƒç•Œç·š */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem; /* UFOã®æ–‡å­—ã‚µã‚¤ã‚º */
            transition: background-color 0.2s ease; /* èƒŒæ™¯è‰²ã®é·ç§» */
            position: relative; /* ç…§æº–ç”¨ */
            /* ãƒ†ã‚­ã‚¹ãƒˆé¸æŠä¸å¯ã« */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        .center-cell {
            /* ä¸­å¤®ã®ã‚»ãƒ«ã‚’å¼·èª¿è¡¨ç¤º (ç…§æº–) */
            outline: 2px solid red;
            outline-offset: -2px;
            z-index: 10; /* ä»–ã®è¦ç´ ã‚ˆã‚Šæ‰‹å‰ã« */
        }
        .ufo-legend img {
            width: 30px;
            height: 30px;
            margin-right: 8px;
        }
        .game-over-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8); /* åŠé€æ˜åº¦ã‚’å°‘ã—ä¸Šã’ã‚‹ */
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            font-size: 1.5rem; /* å°‘ã—å°ã•ãã—ã¦å†…è¨³è¡¨ç¤ºã‚¹ãƒšãƒ¼ã‚¹ç¢ºä¿ */
            z-index: 50; /* æœ€å‰é¢ã«è¡¨ç¤º */
        }
        /* ãƒ¯ãƒ¼ãƒ«ãƒ‰ã®æ˜ã‚‹ã•è¡¨ç¾ (ä¾‹) */
        .brightness-10 { background-color: #2a2a2a; }
        .brightness-9 { background-color: #3a3a3a; }
        .brightness-8 { background-color: #4a4a4a; }
        .brightness-7 { background-color: #5a5a5a; }
        .brightness-6 { background-color: #6a6a6a; }
        .brightness-5 { background-color: #7a7a7a; } /* ä¸­å¿ƒã«è¿‘ã„ */
        .brightness-4 { background-color: #8a8a8a; }
        .brightness-3 { background-color: #9a9a9a; }
        .brightness-2 { background-color: #aaaaaa; }
        .brightness-1 { background-color: #bbbbbb; } /* ä¸­å¿ƒ */

        /* ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        button {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <h1 class="text-3xl font-bold mb-6">UFOã‚·ãƒ¥ãƒ¼ã‚¿ãƒ¼</h1>

    <div class="flex flex-col md:flex-row items-start gap-8 w-full max-w-4xl">
        <div class="flex-grow flex flex-col items-center">
            <div id="monitor" class="monitor-grid mb-4">
                </div>
            <p class="text-lg">æ–¹å‘ã‚­ãƒ¼: ç§»å‹• / ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼: ç ´å£Š</p>
        </div>

        <div class="w-full md:w-64 bg-gray-800 p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold mb-4">æƒ…å ±</h2>
            <div class="mb-4">
                <p>ã‚¹ã‚³ã‚¢: <span id="score" class="font-bold text-yellow-400">0</span></p>
            </div>
            <div class="mb-4">
                <p>æ®‹ã‚Šæ™‚é–“: <span id="timer" class="font-bold text-red-500">30</span> ç§’</p>
            </div>
            <button id="startButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mb-6">
                ã‚¹ã‚¿ãƒ¼ãƒˆ
            </button>

            <h3 class="text-lg font-semibold mb-3">UFOã®ç¨®é¡ã¨ãƒã‚¤ãƒ³ãƒˆ</h3>
            <ul id="ufoLegend" class="space-y-2 ufo-legend text-sm">
                </ul>
        </div>
    </div>

    <div id="gameOverOverlay" class="game-over-overlay hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full">
            <h2 id="gameOverTitle" class="text-3xl md:text-4xl font-bold mb-4">ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼</h2>
            <p id="finalScore" class="text-xl md:text-2xl mb-4">æœ€çµ‚ã‚¹ã‚³ã‚¢: 0</p>
            <div id="destroyedCountsDisplay" class="text-base md:text-lg mb-6 space-y-1 text-left px-4">
                <h3 class="text-lg md:text-xl font-semibold mb-2 text-center">ç ´å£Šã—ãŸUFO:</h3>
                </div>
            <button id="restartButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mt-2">
                ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤
            </button>
        </div>
    </div>

    <script>
        // --- å®šæ•° ---
        const MONITOR_SIZE = 5; // ãƒ¢ãƒ‹ã‚¿ãƒ¼ã®ã‚µã‚¤ã‚º (5x5)
        const WORLD_WIDTH = 25; // ãƒ¯ãƒ¼ãƒ«ãƒ‰ã®å¹…
        const WORLD_HEIGHT = 25; // ãƒ¯ãƒ¼ãƒ«ãƒ‰ã®é«˜ã•
        const GAME_DURATION = 30; // ã‚²ãƒ¼ãƒ æ™‚é–“ (ç§’)
        const INITIAL_UFO_COUNT = 15; // åˆæœŸUFOæ•°
        const UFO_TYPES = [ // UFOã®ç¨®é¡ã¨ãƒã‚¤ãƒ³ãƒˆ
            { type: 'ğŸ›¸', points: 10, emoji: 'ğŸ›¸' }, // æ¨™æº–UFO
            { type: 'ğŸ‘¾', points: 20, emoji: 'ğŸ‘¾' }, // ã‚¨ã‚¤ãƒªã‚¢ãƒ³
            { type: 'ğŸ‘½', points: 30, emoji: 'ğŸ‘½' }, // ã‚°ãƒ¬ã‚¤
            { type: 'ğŸš€', points: 5, emoji: 'ğŸš€' }   // é«˜é€Ÿãƒ­ã‚±ãƒƒãƒˆ (ãƒã‚¤ãƒ³ãƒˆä½ã‚)
        ];

        // --- DOMè¦ç´  ---
        const monitorGrid = document.getElementById('monitor');
        const scoreDisplay = document.getElementById('score');
        const timerDisplay = document.getElementById('timer');
        const startButton = document.getElementById('startButton');
        const ufoLegend = document.getElementById('ufoLegend');
        const gameOverOverlay = document.getElementById('gameOverOverlay');
        const finalScoreDisplay = document.getElementById('finalScore');
        const destroyedCountsDisplay = document.getElementById('destroyedCountsDisplay'); // ç ´å£Šæ•°è¡¨ç¤ºç”¨Div
        const restartButton = document.getElementById('restartButton');

        // --- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ---
        let score = 0;
        let timeLeft = GAME_DURATION;
        let gameInterval = null;
        let gameActive = false;
        let monitorView = { x: Math.floor(WORLD_WIDTH / 2) - Math.floor(MONITOR_SIZE / 2), y: Math.floor(WORLD_HEIGHT / 2) - Math.floor(MONITOR_SIZE / 2) }; // ãƒ¢ãƒ‹ã‚¿ãƒ¼å·¦ä¸Šã®ãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™
        let ufos = []; // { x, y, typeInfo }
        let monitorCells = []; // ãƒ¢ãƒ‹ã‚¿ãƒ¼ã®DOMè¦ç´ ã‚’ä¿æŒ
        let destroyedUfoCounts = {}; // ç ´å£Šã—ãŸUFOã®æ•°ã‚’ç¨®é¡åˆ¥ã«è¨˜éŒ² { 'ğŸ›¸': 0, ... }

        // --- ã‚µã‚¦ãƒ³ãƒ‰ ---
        let moveSynth, explosionSynth;
        // Tone.jsã®åˆæœŸåŒ–ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¾Œã«è¡Œã†ã®ãŒæ¨å¥¨ã•ã‚Œã‚‹ãŸã‚ã€ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³å†…ã§è¡Œã†
        function initAudio() {
            if ((moveSynth && explosionSynth) || typeof Tone === 'undefined') return;
            try {
                 if (!moveSynth) {
                    moveSynth = new Tone.Synth({
                        oscillator: { type: 'square' },
                        envelope: { attack: 0.01, decay: 0.1, sustain: 0, release: 0.1 }
                    }).toDestination();
                 }
                 if (!explosionSynth) {
                    explosionSynth = new Tone.NoiseSynth({
                        noise: { type: 'white' },
                        envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.2 }
                    }).toDestination();
                 }
            } catch (error) {
                console.error("Audio initialization failed:", error);
                moveSynth = null; explosionSynth = null;
            }
        }

        function playMoveSound() {
            if (moveSynth && Tone.context.state === 'running') {
                try { moveSynth.triggerAttackRelease('C5', '16n', Tone.now()); }
                catch (error) { console.warn("playMoveSound error:", error.message); }
            }
        }

        function playExplosionSound() {
            if (explosionSynth && Tone.context.state === 'running') {
                 try { explosionSynth.triggerAttackRelease('0.2n', Tone.now()); }
                 catch (error) { console.warn("playExplosionSound error:", error.message); }
            }
        }

        // --- ãƒ¯ãƒ¼ãƒ«ãƒ‰ã®ä¸­å¿ƒ ---
        const worldCenterX = Math.floor(WORLD_WIDTH / 2);
        const worldCenterY = Math.floor(WORLD_HEIGHT / 2);
        const maxDist = Math.sqrt(worldCenterX**2 + worldCenterY**2);

        // --- é–¢æ•° ---

        function getBrightnessClass(worldX, worldY) {
            const dist = Math.sqrt((worldX - worldCenterX)**2 + (worldY - worldCenterY)**2);
            const normalizedDist = maxDist > 0 ? dist / maxDist : 0;
            const brightnessLevel = Math.max(1, Math.min(10, 1 + Math.floor(normalizedDist * 9)));
            return `brightness-${11 - brightnessLevel}`;
        }

        function createMonitorGrid() {
            monitorGrid.innerHTML = '';
            monitorCells = [];
            const centerIndex = Math.floor(MONITOR_SIZE / 2);
            for (let r = 0; r < MONITOR_SIZE; r++) {
                monitorCells[r] = [];
                for (let c = 0; c < MONITOR_SIZE; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('monitor-cell');
                    cell.dataset.row = r; cell.dataset.col = c;
                    if (r === centerIndex && c === centerIndex) {
                        cell.classList.add('center-cell');
                    }
                    monitorGrid.appendChild(cell);
                    monitorCells[r][c] = cell;
                }
            }
        }

        function displayUfoLegend() {
            ufoLegend.innerHTML = '';
            UFO_TYPES.forEach(ufo => {
                const li = document.createElement('li');
                li.classList.add('flex', 'items-center');
                li.innerHTML = `<span class="text-2xl mr-2">${ufo.emoji}</span> ${ufo.points} ãƒã‚¤ãƒ³ãƒˆ`;
                ufoLegend.appendChild(li);
            });
        }

        function spawnUfo() {
            if (ufos.length >= INITIAL_UFO_COUNT * 2) return;
            const typeInfo = UFO_TYPES[Math.floor(Math.random() * UFO_TYPES.length)];
            const centerOffset = Math.floor(MONITOR_SIZE / 2);
            const minSpawnX = centerOffset;
            const maxSpawnX = WORLD_WIDTH - 1 - centerOffset;
            const minSpawnY = centerOffset;
            const maxSpawnY = WORLD_HEIGHT - 1 - centerOffset;
            if (minSpawnX > maxSpawnX || minSpawnY > maxSpawnY) return;

            let x, y, occupied;
            let attempts = 0; const maxAttempts = 50;
            do {
                x = Math.floor(Math.random() * (maxSpawnX - minSpawnX + 1)) + minSpawnX;
                y = Math.floor(Math.random() * (maxSpawnY - minSpawnY + 1)) + minSpawnY;
                occupied = ufos.some(ufo => ufo.x === x && ufo.y === y);
                attempts++;
            } while (occupied && attempts < maxAttempts);

            if (!occupied) { ufos.push({ x, y, typeInfo }); }
            else { console.warn("Could not find empty spot for UFO."); }
        }

        function spawnInitialUfos() {
            ufos = [];
            for (let i = 0; i < INITIAL_UFO_COUNT; i++) { spawnUfo(); }
        }

        function updateMonitor() {
            if (!monitorCells.length) return;
            const centerRow = Math.floor(MONITOR_SIZE / 2);
            const centerCol = Math.floor(MONITOR_SIZE / 2);

            for (let r = 0; r < MONITOR_SIZE; r++) {
                for (let c = 0; c < MONITOR_SIZE; c++) {
                    if (!monitorCells[r] || !monitorCells[r][c]) continue;
                    const cell = monitorCells[r][c];
                    const worldX = monitorView.x + c;
                    const worldY = monitorView.y + r;

                    const brightnessClass = getBrightnessClass(worldX, worldY);
                    let needsUpdate = true;
                    for (const className of cell.classList) {
                        if (className.startsWith('brightness-')) {
                            if (className === brightnessClass) { needsUpdate = false; }
                            else { cell.classList.remove(className); }
                            break;
                        }
                    }
                    if (needsUpdate) { cell.classList.add(brightnessClass); }

                    const isCenter = (r === centerRow && c === centerCol);
                    if (isCenter) { if (!cell.classList.contains('center-cell')) cell.classList.add('center-cell'); }
                    else { if (cell.classList.contains('center-cell')) cell.classList.remove('center-cell'); }

                    const ufo = ufos.find(u => u.x === worldX && u.y === worldY);
                    const currentContent = cell.textContent;
                    const newContent = ufo ? ufo.typeInfo.emoji : '';
                    if (currentContent !== newContent) { cell.textContent = newContent; }
                }
            }
        }

        function movePlayer(dx, dy) {
            if (!gameActive) return;
            const originalX = monitorView.x; const originalY = monitorView.y;
            const newX = monitorView.x + dx; const newY = monitorView.y + dy;
            const minX = 0; const maxX = WORLD_WIDTH - MONITOR_SIZE;
            const minY = 0; const maxY = WORLD_HEIGHT - MONITOR_SIZE;
            let moved = false;

            if (dx !== 0 && newX >= minX && newX <= maxX) {
                monitorView.x = newX;
                if (originalX !== monitorView.x) { moved = true; }
            }
            if (dy !== 0 && newY >= minY && newY <= maxY) {
                monitorView.y = newY;
                if (originalY !== monitorView.y) { moved = true; }
            }
            if (moved) { playMoveSound(); updateMonitor(); }
        }

        function shootUfo() {
            if (!gameActive) return;
            const centerRow = Math.floor(MONITOR_SIZE / 2);
            const centerCol = Math.floor(MONITOR_SIZE / 2);
            const targetWorldX = monitorView.x + centerCol;
            const targetWorldY = monitorView.y + centerRow;
            const targetIndex = ufos.findIndex(ufo => ufo.x === targetWorldX && ufo.y === targetWorldY);

            if (targetIndex !== -1) {
                const destroyedUfo = ufos[targetIndex];
                score += destroyedUfo.typeInfo.points;
                scoreDisplay.textContent = score;

                // --- ç ´å£Šæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ ---
                const destroyedType = destroyedUfo.typeInfo.emoji;
                if (destroyedUfoCounts[destroyedType] !== undefined) {
                    destroyedUfoCounts[destroyedType]++;
                }
                // --- ã“ã“ã¾ã§è¿½åŠ  ---

                ufos.splice(targetIndex, 1);
                playExplosionSound();
                spawnUfo();
                updateMonitor();
            }
        }

        function updateTimer() {
            timeLeft--;
            timerDisplay.textContent = timeLeft;
            if (timeLeft <= 0) { endGame(); }
        }

        function startGame() {
            if (gameActive) return;

            if (typeof Tone !== 'undefined' && Tone.context.state !== 'running') {
                 Tone.start().then(() => { initAudio(); }).catch(e => console.error("AudioContext start failed:", e));
            } else { initAudio(); }

            score = 0;
            timeLeft = GAME_DURATION;
            gameActive = true;
            monitorView = { x: Math.floor(WORLD_WIDTH / 2) - Math.floor(MONITOR_SIZE / 2), y: Math.floor(WORLD_HEIGHT / 2) - Math.floor(MONITOR_SIZE / 2) };

            // --- ç ´å£Šæ•°ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ ---
            destroyedUfoCounts = {};
            UFO_TYPES.forEach(ufo => {
                destroyedUfoCounts[ufo.emoji] = 0; // å„ã‚¿ã‚¤ãƒ—ã‚’0ã§åˆæœŸåŒ–
            });
            // --- ã“ã“ã¾ã§è¿½åŠ  ---

            scoreDisplay.textContent = score;
            timerDisplay.textContent = timeLeft;
            startButton.disabled = true;
            startButton.textContent = "ãƒ—ãƒ¬ã‚¤ä¸­...";
            startButton.classList.add('opacity-50', 'cursor-not-allowed');
            gameOverOverlay.classList.add('hidden');

            spawnInitialUfos();
            updateMonitor();

            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(updateTimer, 1000);

            document.removeEventListener('keydown', handleKeyDown);
            document.addEventListener('keydown', handleKeyDown);
        }

        function endGame() {
            gameActive = false;
            clearInterval(gameInterval); gameInterval = null;
            startButton.disabled = false;
            startButton.textContent = "ã‚¹ã‚¿ãƒ¼ãƒˆ";
            startButton.classList.remove('opacity-50', 'cursor-not-allowed');
            document.removeEventListener('keydown', handleKeyDown);

            // --- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ã«ç ´å£Šæ•°ã‚’è¡¨ç¤º ---
            destroyedCountsDisplay.innerHTML = ''; // å‰å›ã®å†…å®¹ã‚’ã‚¯ãƒªã‚¢
            destroyedCountsDisplay.innerHTML = '<h3 class="text-lg md:text-xl font-semibold mb-2 text-center">ç ´å£Šã—ãŸUFO:</h3>'; // è¦‹å‡ºã—ã‚’è¿½åŠ 

            let hasDestroyedAny = false; // ä½•ã‹ç ´å£Šã—ãŸã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
            // UFO_TYPESã®é †ç•ªã§è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ãƒ«ãƒ¼ãƒ—ã‚’å¤‰æ›´
            UFO_TYPES.forEach(ufoType => {
                 const emoji = ufoType.emoji;
                 const count = destroyedUfoCounts[emoji];
                 if (count > 0) {
                     const p = document.createElement('p');
                     // çµµæ–‡å­—ã¨æ•°ã‚’è¡¨ç¤º (ä¾‹: ğŸ›¸ x 5)
                     p.innerHTML = `<span class="inline-block w-6 text-center">${emoji}</span> x ${count}`; // çµµæ–‡å­—ã®å¹…ã‚’æƒãˆã‚‹
                     destroyedCountsDisplay.appendChild(p);
                     hasDestroyedAny = true;
                 }
            });

            // 1ã¤ã‚‚ç ´å£Šã—ãªã‹ã£ãŸå ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if (!hasDestroyedAny) {
                 const p = document.createElement('p');
                 p.textContent = 'ãªã—';
                 p.classList.add('text-center', 'italic'); // ä¸­å¤®å¯„ã›ã€ã‚¤ã‚¿ãƒªãƒƒã‚¯
                 // è¦‹å‡ºã—ã®ä¸‹ã«è¿½åŠ 
                 destroyedCountsDisplay.appendChild(p);
            }
            // --- ã“ã“ã¾ã§è¿½åŠ  ---

            finalScoreDisplay.textContent = `æœ€çµ‚ã‚¹ã‚³ã‚¢: ${score}`;
            gameOverOverlay.classList.remove('hidden');
        }

        function handleKeyDown(event) {
            if (!gameActive || event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') return;
            let interaction = false; // ç§»å‹•ã¾ãŸã¯å°„æ’ƒãŒè¡Œã‚ã‚ŒãŸã‹
            switch (event.key) {
                case 'ArrowUp': case 'w': movePlayer(0, -1); interaction = true; break;
                case 'ArrowDown': case 's': movePlayer(0, 1); interaction = true; break;
                case 'ArrowLeft': case 'a': movePlayer(-1, 0); interaction = true; break;
                case 'ArrowRight': case 'd': movePlayer(1, 0); interaction = true; break;
                case ' ': shootUfo(); interaction = true; break;
            }
            if (interaction) { event.preventDefault(); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            createMonitorGrid();
            displayUfoLegend();
            updateMonitor();
            startButton.addEventListener('click', startGame);
            restartButton.addEventListener('click', () => {
                 gameOverOverlay.classList.add('hidden');
                 setTimeout(startGame, 100);
            });
        });
    </script>

</body>
</html>
